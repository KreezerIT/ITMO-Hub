# Лабораторная работа №6. *Трансляция адресов в ОС Linux*

[Файл с полным ТЗ+Теория](Net_LabDescription_6.pdf)

## Цель работы
Закрепить понимание принципов работы NAT и firewall, а также получить начальные навыки конфигурирования NAT и межсетевого экрана в операционной системе Linux.

## Требования
- Среда виртуализации Oracle VirtualBox
- Виртуальная машина Linux CentOS 7 (допускается использование другой ОС Linux, однако описание приводится для CentOS 7)

---

## Краткие теоретические сведения
Linux содержит встроенные средства для организации интернет-шлюзов, удаленного доступа и фильтрации сетевого трафика.  
Технология **NAT (Network Address Translation)** позволяет изменять заголовки IP-пакетов и TCP/UDP-сообщений, обеспечивая доступ из локальных сетей с приватными адресами во внешние сети, а также публикацию внутренних сервисов.

Межсетевой экран (firewall) предназначен для фильтрации сетевых пакетов по IP-адресам, портам и используемым протоколам.  
В Linux для управления firewall используются `iptables`, `nftables` и `firewalld`.  
Для пересылки пакетов между интерфейсами требуется включить параметр ядра `net.ipv4.ip_forward`.

---

## Часть 1. Подготовка и проверка конфигурации

1. Запустить виртуальную машину Linux и удалить сервис `firewalld`.
2. Установить пакет `iptables-services` и настроить автозапуск `iptables`.
3. Создать связанный клон виртуальной машины:
    - c7-1
    - c7-2
4. Для машины c7-1 добавить второй сетевой интерфейс.
5. Подключить интерфейсы c7-2 и второй интерфейс c7-1 к внутренней сети `intnet`.
6. Основной интерфейс c7-1 подключить к NAT.
7. Назначить адреса:
    - c7-1: 10.0.0.1/24
    - c7-2: 10.0.0.2/24
8. Для внешнего интерфейса c7-1 оставить получение адреса по DHCP.
9. Отключить IPv6 на обеих машинах.
10. Задать имена хостов в соответствии с именами виртуальных машин.
11. Проверить связность хостов по внутренней сети и доступ в Интернет с c7-1.
12. Убедиться, что на c7-2 шлюзом по умолчанию указан c7-1.
13. Настроить DNS на c7-2: 8.8.8.8 и 77.88.8.1.
14. Проверить, что на c7-1 разрешена пересылка IP-пакетов между интерфейсами.

---

## Часть 2. Создание пользователей и настройка OpenSSH

1. На c7-2 создать пользователя `FIOuser`, где FIO — инициалы студента.
2. Отредактировать `/etc/ssh/sshd_config`, чтобы:
    - запретить вход по SSH пользователю root;
    - ограничить число попыток ввода пароля до 2;
    - установить тайм-аут авторизации 30 секунд;
    - отключить DNS-разрешение имен.
3. Перезапустить сервис `sshd`.
4. Подключиться с c7-1 к c7-2 по SSH под новым пользователем.

---

## Часть 3. Настройка NAT на шлюзе

1. На c7-1 включить пересылку IP-пакетов.
2. Настроить клиентский NAT (SNAT или MASQUERADE) для доступа во внешнюю сеть.
3. Опубликовать порт tcp/22 хоста c7-2 на внешнем интерфейсе c7-1 как tcp/55022.
4. Сохранить правила с помощью `iptables-save` в файл `/etc/sysconfig/iptables` и определить назначение строк.
5. Подключиться к c7-2 по SSH с основной ОС.
6. Проверить доступность внешних узлов с c7-2 с помощью `ping`, при необходимости скорректировать правила.

---

## Часть 4. Установка дополнительного ПО

1. На c7-1 установить консольный браузер (lynx или links) и утилиту `nmap`.
2. На c7-2 установить и запустить web-сервер `lighttpd`, настроить автозапуск и работу по IPv4.
3. С c7-1 проверить открытые порты c7-2 с помощью `nmap`.
4. Проверить доступ к web-серверу с c7-1 и при необходимости разрешить доступ через `iptables`.

---

## Часть 5. Исследование соединений

1. На c7-2 с помощью `ss`, `netstat` или `lsof` вывести:
    - активные соединения;
    - прослушиваемые сетевые сокеты.
2. На c7-1 с помощью `tcpdump` отобразить трафик внутреннего и внешнего интерфейсов.
3. С c7-2 отправить 5 TCP-сегментов до `ya.ru` с помощью `mtr`.
4. Определить изменения пакетов при NAT-трансляции.
5. Закрыть все SSH-сессии с c7-2.
6. На c7-2 проанализировать TCP-флаги при установлении SSH-соединения.
7. Подключиться по SSH к c7-2 с основной ОС и проанализировать процесс установки соединения.

---

## Часть 6. Настройка шлюза

1. Установить политики по умолчанию INPUT и FORWARD — запрет.
2. Добавить правила, которые:
    - разрешают доступ к опубликованному SSH-порту c7-2;
    - разрешают DNS-запросы только к 8.8.8.8 и 77.88.8.1;
    - разрешают доступ к POP3, HTTP/HTTPS, SSH из внутренней сети;
    - запрещают трафик с заданных IP и подсетей;
    - запрещают SSH-доступ к c7-1 извне;
    - разрешают SSH-доступ к c7-1 из внутренней сети;
    - ограничивают ICMP-трафик согласно условиям задания.

---

## Часть 7. Доступ через SSH к защищенным сервисам

1. С помощью SSH-туннелирования обеспечить доступ к web-серверу c7-2 с основного компьютера по адресу `127.0.0.80:8888`.

---

## Требования к отчету
Отчет должен быть выполнен в формате DOC/DOCX или PDF и содержать:
- измененные параметры `sshd`;
- итоговые файлы `/etc/sysconfig/iptables`;
- команды и консольный вывод ключевых этапов работы;
- команду SSH-подключения с пробросом портов.
