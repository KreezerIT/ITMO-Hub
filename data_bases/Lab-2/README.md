# *Лабораторная работа №2*

> `GROUP BY` `aggregate func`

Язык так же позволяет обрабатывать данные и возвращать вычисляемые
значения, это может пригодиться для аналитики. Выражение GROUP BY
позволяет объединить данные по определенному атрибуту и вычислить
значения группы с помощью агрегатной функции.

Примеры агрегатных функций:

COUNT — считает количество строк в таблице.

SUM — вычисляет суммы выбранных атрибутов.

MAX и MIN — находят максимальное и минимальное значение определенного
атрибутов.

AVG — вычисляет среднее значение атрибутов.

[Список всех функций](https://www.postgresql.org/docs/current/functions-aggregate.html)

Рассмотрим на примере:

```SQL
SELECT COUNT(DISTINCT сolor) FROM production.product
WHERE color IS NOT NULL
```

В данном случае будет выполнен SELECT, который отберет из таблицы все
строки, для которых цвет определен, и будет выполнена агрегирующая
функция COUNT, которая посчитает количество различных цветов. Инструкция
DISTINCT обеспечивает выбор неповторяющейся значений цвета, а функция
COUNT считает количество полученных значений.

Запрос следующего вида фактически возвращает количество строк, для
которых определен цвет продукта:

```SQL
SELECT COUNT(color) FROM production.product
WHERE color IS NOT NULL
```

Выражение GROUP BY позволяет разделить результат выполнения запроса на
группы и выполнить ту или иную функцию над каждой из групп.

```SQL
SELECT color, COUNT(*) AS amount
FROM production.product
WHERE color IS NOT NULL
GROUP BY color
```

В данном запросе все строки, для которых выполнено условие «цвет
определен», разделены на группы по цвету, и над каждой группой
выполняется функция COUNT. Результатом станет два атрибута в выборке --
цвет и количество строк с данным цветом в общей выборке.

Необходимо сделать несколько важных дополнений. При группировке запрос
возвращает только те данные, которые имеют одно и то же значение для
всей группы. Запрос вида

```SQL
SELECT name, color, COUNT(*) AS amount
FROM production.product
WHERE color IS NOT NULL
GROUP BY color
```

не будет выполнен, так как в группе может существовать несколько товаров
с разными названиями. Даже если фактически в каждой группе с одним и тем
же цветом все товары имеют одно и то же название, все равно это будет
ошибкой.

Если столбец, по которому осуществляется группировка, содержит значения
NULL, то они будут рассмотрены как идентичные и будут образовывать
отдельную группу.

Допускается группировка по результату выполнения простых математических
операций, а также группировка по двум и более атрибутам:

```SQL
SELECT color, style, COUNT(*) AS amount
FROM production.product
WHERE color IS NOT NULL AND style IS NOT NULL
GROUP BY color, style
```

Выражение GROUP BY используется совместно с выражением HAVING,
которое определяет условие уже после группировки. (WHERE сначала
фильтрует данные, а потом данные будут группироваться)

```SQL
SELECT color, COUNT(*) AS amount
FROM production.product
WHERE color IS NOT NULL
GROUP BY color
HAVING COUNT(*)>10
```

Данный запрос выдаст название цветов, количество товаров данного цвета,
но только для тех групп, где это количество больше 10. Естественно,
будет выполнено условие, что цвет товаров определен.

Существуют специальные конструкции, выполняющие группировку с
определёнными правилами. Рассмотрим конструкцию GROUP BY ROLLUP, которая
выводить и общие и промежуточные итоги группировки. Частный синтаксис
будет такой:

```SQL
SELECT столбец1, столбец2, столбец3, COUNT(*)
FROM таблица
GROUP BY ROLLUP (столбец1, столбец2, столбец3)
```

В данном случае будут выведены итоги общей группировки по трем
атрибутам, а также добавлены результаты промежуточной группировки. В
данном примере промежуточная группировка это строки полученные в
результате группировки по первым двум атрибутам, третий столбец будет
иметь значение NULL, это строки полученные в результате группировки по
первому атрибуту, второй и третий будут иметь значение NULL, и одна
строка где первый, второй и третий атрибуты будут иметь значение NULL.

Для понимания ее работы нам понадобится простой пример группировки.

```SQL
SELECT color, style, class, COUNT(*)
FROM production.product
GROUP BY color, style, class
```

В данном случае пользователь увидит окончательный результат работы
группировки по трем атрибутам, четвертый столбец это число продуктов, в
группе с одинаковым классом, стилем и цветом.

Операция GROUP BY CUBE( ), только к базовой группировке GROUP BY
добавляются все возможные сочетания параметров группировки.

**CUBE** возвращает данные для всех возможных сочетаний колонок,
перечисленных внутри. То есть для случая **CUBE(*c1, c2, c3*)** (где с1,
c2, c3  — имена колонок) будут возвращены следующие сочетания:\
*(с1, null, null)*\
*(null, c2, null)*\
*(null, null, c3)*\
*(c1, c2, null)*\
*(c1, null, c3)*\
*(null, c2, c3)*\
*(c1, c2, c3)*\
*(null, null, null)*

```SQL
SELECT color, style, class, COUNT(*)
FROM production.product
GROUP BY CUBE (color, style, class)
```

GROUP BY ROLLUP Работает схожим образом, с тем отличием,
что **ROLLUP** генерирует сочетания, убирая колонки по одной с конца.
Таким образом, **ROLLUP(*c1, c2, c3, c4*)** вернет следующие сочетания:

*(c1, c2, c3, c4)*\
*(c1, c2, c3, null)*\
*(c1, c2, null, null)*\
*(c1, null, null, null)*\
*(null, null, null, null)*


```SQL
SELECT color, style, class, COUNT(*)
FROM production.product
GROUP BY ROLLUP (color, style, class)
```

Пользователь получает все те же строки, как и при обычном GROUP BY, а
также дополнительный набор с группировкой по цвету и стилю,
дополнительный набор с группировкой только по цвету и строку без
группировки.

Конструкция GROUP BY GROUPING SETS ( ) позволяет объединить несколько
операций GROUP BY.

```SQL
SELECT COUNT(*)
FROM production.product
GROUP BY GROUPING SETS ((color),(size))
```
